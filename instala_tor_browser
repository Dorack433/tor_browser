#!/bin/bash

LINK="https://www.torproject.org/dist/torbrowser/15.0.3/tor-browser-linux-x86_64-15.0.3.tar.xz"
DESTINO="/opt/tor-browser"
TMPDIR="$(mktemp -d)"

# Precisa ser root
if [[ $EUID -ne 0 ]]; then
    echo "[!] Execute como root: sudo $0"
    exit 1
fi

USUARIO_REAL="${SUDO_USER:-$USER}"

echo "[*] Verificando dependências..."
for pkg in wget tar; do
    command -v "$pkg" >/dev/null 2>&1 || {
        echo "[!] O pacote '$pkg' não está instalado."
        exit 1
    }
done

echo "[*] Removendo instalação anterior (se existir)..."
rm -rf "$DESTINO"

echo "[*] Baixando Tor Browser..."
wget -O "$TMPDIR/tor-browser.tar.xz" "$LINK" || { echo "[!] Erro no download!"; exit 1; }

echo "[*] Extraindo..."
tar -xf "$TMPDIR/tor-browser.tar.xz" -C "$TMPDIR" || { echo "[!] Erro ao extrair!"; exit 1; }

echo "[*] Movendo para $DESTINO..."
mv "$TMPDIR/tor-browser" "$DESTINO" || { echo "[!] Erro ao mover!"; exit 1; }

chmod +x "$DESTINO/start-tor-browser.desktop"

echo "[*] Registrando aplicação para o usuário $USUARIO_REAL ..."
sudo -u "$USUARIO_REAL" bash -c "cd '$DESTINO' && ./start-tor-browser.desktop --register-app"

echo "[✓] Tor Browser instalado e registrado com sucesso!"
echo "Abra pelo menu do sistema ou execute:"
echo "$DESTINO/start-tor-browser.desktop"
